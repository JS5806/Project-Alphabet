-- 1. ì‚¬ìš©ì í”„ë¡œí•„ í…Œì´ë¸” (auth.users í™•ì¥)
create table public.profiles (
  id uuid references auth.users not null primary key,
  email text,
  full_name text,
  avatar_url text,
  created_at timestamptz default now()
);

-- 2. ì‹ë‹¹ í…Œì´ë¸”
create table public.restaurants (
  id bigint generated by default as identity primary key,
  name text not null,
  description text,
  image_url text,
  category text,
  created_at timestamptz default now()
);

-- 3. íˆ¬í‘œ ë¡œê·¸ í…Œì´ë¸”
create table public.votes (
  id bigint generated by default as identity primary key,
  user_id uuid references public.profiles(id) not null,
  restaurant_id bigint references public.restaurants(id) not null,
  voted_at timestamptz default now(),
  constraint unique_user_vote_today unique (user_id, date(voted_at)) -- í•˜ë£¨ 1íšŒ íˆ¬í‘œ ì œí•œ
);

-- 4. ì¸ë±ìŠ¤ ì„¤ì • (ì„±ëŠ¥ ìµœì í™”)
create index idx_votes_restaurant_id on public.votes(restaurant_id);
create index idx_votes_user_id on public.votes(user_id);
create index idx_votes_date on public.votes(date(voted_at));

-- 5. RLS (Row Level Security) ë³´ì•ˆ ì •ì±… ìˆ˜ë¦½
alter table public.profiles enable row level security;
alter table public.restaurants enable row level security;
alter table public.votes enable row level security;

-- í”„ë¡œí•„: ë³¸ì¸ë§Œ ìˆ˜ì •, ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ì¡°íšŒ ê°€ëŠ¥
create policy "Public profiles are viewable by everyone" on public.profiles
  for select using (auth.role() = 'authenticated');
create policy "Users can insert their own profile" on public.profiles
  for insert with check (auth.uid() = id);

-- ì‹ë‹¹: ì¸ì¦ëœ ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥, ë“±ë¡ì€ ëˆ„êµ¬ë‚˜(ë˜ëŠ” ê´€ë¦¬ìë§Œ ì„¤ì • ê°€ëŠ¥)
create policy "Restaurants are viewable by authenticated users" on public.restaurants
  for select using (auth.role() = 'authenticated');
create policy "Authenticated users can create restaurants" on public.restaurants
  for insert with check (auth.role() = 'authenticated');

-- íˆ¬í‘œ: ë³¸ì¸ì˜ íˆ¬í‘œë§Œ ìƒì„± ë° ì‚­ì œ ê°€ëŠ¥, ì¡°íšŒëŠ” ì „ì²´ ê°€ëŠ¥(ì§‘ê³„ìš©)
create policy "Users can vote" on public.votes
  for insert with check (auth.uid() = user_id);
create policy "Users can change their own vote" on public.votes
  for delete using (auth.uid() = user_id);
create policy "Votes are viewable by everyone" on public.votes
  for select using (auth.role() = 'authenticated');

-- 6. ì´ë©”ì¼ ë„ë©”ì¸ ê²€ì¦ íŠ¸ë¦¬ê±° (ì‚¬ë‚´ ì´ë©”ì¼ ê°•ì œ)
create or replace function public.validate_email_domain()
returns trigger as $$
begin
  if split_part(new.email, '@', 2) != 'yourcompany.com' then
    raise exception 'Only company email addresses are allowed.';
  end if;
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.validate_email_domain();

-- 7. íŠ¸ë¦¬ê±°: ìƒˆ ì‚¬ìš©ì ê°€ì… ì‹œ í”„ë¡œí•„ ìë™ ìƒì„±
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, email, full_name, avatar_url)
  values (new.id, new.email, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created_profile
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- 8. Realtime êµ¬ë… ì„¤ì • (íˆ¬í‘œ í˜„í™© ì¦‰ì‹œ ë°˜ì˜)
alter publication supabase_realtime add table public.votes;
// Supabase Edge Function (Deno)
// íˆ¬í‘œ ì™„ë£Œ í˜¹ì€ íŠ¹ì • ì´ë²¤íŠ¸ ë°œìƒ ì‹œ Slackìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const SLACK_WEBHOOK_URL = Deno.env.get('SLACK_WEBHOOK_URL')!

serve(async (req) => {
  if (req.method !== 'POST') {
    return new Response('Method Not Allowed', { status: 405 });
  }

  try {
    const { record, type } = await req.json(); // Database Webhook Payload
    
    // íˆ¬í‘œ(INSERT) ì´ë²¤íŠ¸ì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
    if (type === 'INSERT' && record.restaurant_id) {
      const message = {
        text: `ğŸ—³ ìƒˆë¡œìš´ íˆ¬í‘œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (Restaurant ID: ${record.restaurant_id})`,
        blocks: [
            {
                type: "section",
                text: {
                    type: "mrkdwn",
                    text: `*ğŸ—³ ìƒˆë¡œìš´ íˆ¬í‘œ ë°œìƒ!* \nëˆ„êµ°ê°€ ì‹ë‹¹ ID: *${record.restaurant_id}* ì— íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`
                }
            }
        ]
      };

      await fetch(SLACK_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(message),
      });
    }

    return new Response(JSON.stringify({ success: true }), {
      headers: { "Content-Type": "application/json" },
      status: 200,
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { "Content-Type": "application/json" },
      status: 500,
    });
  }
})
import { createClient } from '@supabase/supabase-js'

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true, // ì„¸ì…˜ ìœ ì§€
    autoRefreshToken: true,
  },
  realtime: {
    params: {
      eventsPerSecond: 10, // ìŠ¤ë¡œí‹€ë§ ì¡°ì •
    },
  },
});
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # 1. í…ŒìŠ¤íŠ¸ ë° ë¦°íŠ¸ ê²€ì‚¬
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Lint
        run: npm run lint

      # - name: Run Tests
      #   run: npm run test

  # 2. Vercel ë°°í¬ (Main ë¸Œëœì¹˜ ë³‘í•© ì‹œ)
  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # í”„ë¡œë•ì…˜ ë°°í¬
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["icn1"], 
  "crons": []
}