name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # Docker Buildx 설정 (멀티 플랫폼 빌드 지원 등)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # Docker Hub/ECR 로그인 (Secrets 사용)
    # 실제 사용 시 github repo settings > secrets 에 DOCKER_USERNAME, DOCKER_PASSWORD 등록 필요
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      # 로그인 정보가 없을 경우 스킵하여 CI 테스트만 수행하도록 설정 가능
      if: ${{ env.DOCKER_USERNAME != '' }}

    # 이미지 빌드 및 푸시
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/voting-app:latest
          ${{ secrets.DOCKER_USERNAME }}/voting-app:${{ github.sha }}
      if: ${{ env.DOCKER_USERNAME != '' }}

    # (선택 사항) Terraform Apply 자동화
    # MVP 단계에서는 인프라 변경을 수동 검토 후 적용하는 것이 안전할 수 있음.
    # 여기서는 Terraform 설치 및 검증 단계만 포함.
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init & Validate
      working-directory: ./infra
      run: |
        terraform init
        terraform validate